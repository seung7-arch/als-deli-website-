<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Checkout | Al's Deli</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://js.stripe.com/v3/"></script>
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    body { font-family: 'Inter', sans-serif; }
    
    /* Stripe card element styling */
    .StripeElement {
      padding: 12px 16px;
      border: 1px solid #d1d5db;
      border-radius: 12px;
      background-color: white;
    }
    
    .StripeElement--focus {
      border-color: #dc2626;
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
    }
    
    .StripeElement--invalid {
      border-color: #ef4444;
    }
  </style>
</head>

<body class="bg-gray-50">

  <!-- NAVIGATION -->
  <nav class="bg-white shadow-md">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 bg-red-600 rounded-full flex items-center justify-center text-white font-black text-xl">A</div>
          <a href="index.html" class="text-2xl font-black text-gray-900">AL'S DELI</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- CHECKOUT FORM -->
  <div class="max-w-4xl mx-auto px-4 py-8">
    
    <div class="mb-8">
      <h1 class="text-3xl font-black text-gray-900 mb-2">Checkout</h1>
      <p class="text-gray-600">Complete your order details and payment</p>
    </div>

    <div class="grid lg:grid-cols-2 gap-8">

      <!-- LEFT: Customer Info & Payment -->
      <div class="space-y-6">
        
        <!-- Customer Information -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-black text-gray-900 mb-6">Your Information</h2>

          <form id="checkout-form" class="space-y-4">
            
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Full Name *</label>
              <input type="text" id="customer-name" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" 
                placeholder="John Doe" />
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Phone Number *</label>
              <input type="tel" id="customer-phone" required 
                pattern="[0-9]{3}-[0-9]{3}-[0-9]{4}" 
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" 
                placeholder="202-555-0123" />
              <p class="text-xs text-gray-500 mt-1">Format: 202-555-0123</p>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Pickup Time *</label>
              <select id="pickup-time" required 
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500">
                <option value="">Select pickup time...</option>
                <option value="ASAP">ASAP (15-20 minutes)</option>
                <option value="30min">30 minutes</option>
                <option value="1hour">1 hour</option>
                <option value="2hours">2 hours</option>
                <option value="custom">Custom time (call to confirm)</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Special Instructions (Optional)</label>
              <textarea id="special-instructions" rows="3" 
                class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500" 
                placeholder="Any special requests or dietary restrictions..."></textarea>
            </div>

          </form>
        </div>

        <!-- Payment Information -->
        <div class="bg-white rounded-2xl shadow-lg p-6">
          <h2 class="text-xl font-black text-gray-900 mb-6">Payment Details</h2>

          <div class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Card Information *</label>
              <div id="card-element" class="StripeElement"></div>
              <div id="card-errors" class="text-red-600 text-sm mt-2" role="alert"></div>
            </div>

            <div class="flex items-center gap-2 text-xs text-gray-500">
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
              </svg>
              <span>Your payment information is encrypted and secure</span>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT: Order Summary -->
      <div class="bg-white rounded-2xl shadow-lg p-6 h-fit sticky top-4">
        <h2 class="text-xl font-black text-gray-900 mb-6">Order Summary</h2>

        <div id="order-summary-list" class="space-y-3 mb-6 max-h-96 overflow-y-auto">
          <!-- Items will be inserted here by JavaScript -->
        </div>

        <!-- Minimum Order Notice -->
        <div id="minimum-notice" class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 hidden">
          <div class="flex items-start gap-2">
            <span class="text-yellow-600 text-lg">⚠️</span>
            <div class="text-sm text-yellow-800">
              <span class="font-bold">$10.00 minimum order required</span><br>
              <span id="remaining-amount">Add more items to checkout</span>
            </div>
          </div>
        </div>

        <div class="border-t border-gray-200 pt-4 mb-6">
          <div class="flex justify-between items-center mb-2">
            <span class="text-gray-600">Subtotal</span>
            <span id="subtotal-display" class="font-bold text-gray-900">$0.00</span>
          </div>
          <div class="flex justify-between items-center mb-2">
            <span class="text-gray-600">Tax (10%)</span>
            <span id="tax-display" class="font-bold text-gray-900">$0.00</span>
          </div>
          <div class="flex justify-between items-center text-xl font-black text-gray-900 pt-2 border-t border-gray-200">
            <span>Total</span>
            <span id="total-display">$0.00</span>
          </div>
        </div>

        <button id="pay-now-btn" onclick="processPayment()" 
          class="w-full py-4 bg-green-600 hover:bg-green-700 text-white font-black text-lg rounded-2xl shadow-lg transform active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed" 
          disabled>
          <span id="btn-text">PAY NOW</span>
          <span id="btn-spinner" class="hidden">
            <svg class="animate-spin inline-block h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            PROCESSING...
          </span>
        </button>

        <div class="mt-4 text-center">
          <a href="order.html" class="text-sm text-gray-600 hover:text-red-600 font-semibold">← Back to Menu</a>
        </div>

        <div class="mt-6 flex items-center justify-center gap-2 text-xs text-gray-500">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"/>
          </svg>
          <span>Secure payment powered by Stripe</span>
        </div>
      </div>

    </div>

  </div>

  <script>
    // ============================================
    // CONFIGURATION
    // ============================================
    const STRIPE_PUBLISHABLE_KEY = 'pk_live_51Sb4D39C0u7jlQxKCcQT3DtP3PuBeFjKi8zJjbyFvpssYAUK7xNq4yjgsW9HL6TQA69punF3ZhQu42gKtPjI4KGE00YAHhthjz';
    const TAX_RATE = 0.10; // 10% tax
    const MINIMUM_ORDER = 10.00; // $10 minimum before tax

    // Initialize Stripe
    const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
    const elements = stripe.elements();
    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#1f2937',
          fontFamily: '"Inter", sans-serif',
          '::placeholder': {
            color: '#9ca3af',
          },
        },
        invalid: {
          color: '#ef4444',
        },
      },
    });

    let orderData = { items: [], total: 0 };
    let subtotal = 0;
    let tax = 0;
    let total = 0;

    // Mount card element
    window.addEventListener('DOMContentLoaded', () => {
      cardElement.mount('#card-element');
      
      // Handle real-time validation errors
      cardElement.on('change', (event) => {
        const displayError = document.getElementById('card-errors');
        if (event.error) {
          displayError.textContent = event.error.message;
        } else {
          displayError.textContent = '';
        }
      });

      loadOrder();
    });

    // Load order from localStorage
    function loadOrder() {
      const savedOrder = localStorage.getItem('alsDeliOrder');
      
      if (!savedOrder) {
        alert('Your cart is empty!');
        window.location.href = 'order.html';
        return;
      }

      try {
        orderData = JSON.parse(savedOrder);
        displayOrderSummary();
      } catch (e) {
        console.error('Failed to load order:', e);
        alert('Error loading your order. Please try again.');
        window.location.href = 'order.html';
      }
    }

    // Display order summary
    function displayOrderSummary() {
      const summaryList = document.getElementById('order-summary-list');
      const subtotalDisplay = document.getElementById('subtotal-display');
      const taxDisplay = document.getElementById('tax-display');
      const totalDisplay = document.getElementById('total-display');
      const payBtn = document.getElementById('pay-now-btn');
      const notice = document.getElementById('minimum-notice');
      const remainingAmount = document.getElementById('remaining-amount');

      summaryList.innerHTML = '';
      subtotal = 0;

      if (!orderData.items || orderData.items.length === 0) {
        summaryList.innerHTML = '<p class="text-gray-500 text-center py-8">No items in cart</p>';
        notice.classList.add('hidden');
        return;
      }

      orderData.items.forEach(item => {
        const lineTotal = item.price * item.quantity;
        subtotal += lineTotal;

        const div = document.createElement('div');
        div.className = 'flex justify-between items-start p-3 bg-gray-50 rounded-lg';
        
        const modsHtml = item.modifiers && item.modifiers.length > 0
          ? `<div class="text-xs text-gray-500 mt-1">${item.modifiers.join(', ')}</div>`
          : '';

        div.innerHTML = `
          <div class="flex-1">
            <div class="font-bold text-gray-800">
              ${item.quantity > 1 ? `${item.quantity}x ` : ''}${item.name}
            </div>
            ${modsHtml}
          </div>
          <div class="font-bold text-gray-900">$${lineTotal.toFixed(2)}</div>
        `;

        summaryList.appendChild(div);
      });

      tax = subtotal * TAX_RATE;
      total = subtotal + tax;

      subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
      taxDisplay.textContent = `$${tax.toFixed(2)}`;
      totalDisplay.textContent = `$${total.toFixed(2)}`;

      // Update minimum order notice
      if (subtotal < MINIMUM_ORDER && subtotal > 0) {
        notice.classList.remove('hidden');
        const remaining = MINIMUM_ORDER - subtotal;
        remainingAmount.textContent = `Add $${remaining.toFixed(2)} more to checkout`;
      } else {
        notice.classList.add('hidden');
      }

      // Check minimum order for pay button
      if (subtotal < MINIMUM_ORDER) {
        payBtn.disabled = true;
        payBtn.innerHTML = `
          <span class="text-sm">
            ⚠️ Minimum order: $${MINIMUM_ORDER.toFixed(2)}<br>
            Add $${(MINIMUM_ORDER - subtotal).toFixed(2)} more
          </span>
        `;
        payBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
        payBtn.classList.add('bg-gray-500', 'cursor-not-allowed');
      } else {
        payBtn.disabled = false;
        payBtn.innerHTML = '<span id="btn-text">PAY NOW</span><span id="btn-spinner" class="hidden"><svg class="animate-spin inline-block h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> PROCESSING...</span>';
        payBtn.classList.remove('bg-gray-500', 'cursor-not-allowed');
        payBtn.classList.add('bg-green-600', 'hover:bg-green-700');
      }
    }

    // Process payment
    async function processPayment() {
      const name = document.getElementById('customer-name').value.trim();
      const phone = document.getElementById('customer-phone').value.trim();
      const pickupTime = document.getElementById('pickup-time').value;
      const instructions = document.getElementById('special-instructions').value.trim();

      // Validate form
      if (!name || !phone || !pickupTime) {
        alert('Please fill in all required fields');
        return;
      }

      // Validate phone format
      const phoneRegex = /^\d{3}-\d{3}-\d{4}$/;
      if (!phoneRegex.test(phone)) {
        alert('Please enter phone number in format: 202-555-0123');
        return;
      }

      // Disable button and show loading state
      const payBtn = document.getElementById('pay-now-btn');
      const btnText = document.getElementById('btn-text');
      const btnSpinner = document.getElementById('btn-spinner');
      
      payBtn.disabled = true;
      btnText.classList.add('hidden');
      btnSpinner.classList.remove('hidden');

      try {
        // Step 1: Create Payment Intent via Netlify Function
        console.log('Creating payment intent...');
        const response = await fetch('/.netlify/functions/create-payment-intent', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            amount: total,
            customerName: name,
            items: orderData.items.map(item => ({
              name: item.name,
              price: item.price,
              quantity: item.quantity,
              modifiers: item.modifiers || []
            })),
            customerPhone: phone,
            pickupTime: pickupTime,
            specialInstructions: instructions
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to create payment intent');
        }

        const { clientSecret, confirmationNumber } = await response.json();
        console.log('Payment intent created:', confirmationNumber);

        // Step 2: Confirm payment with Stripe
        console.log('Confirming payment...');
        const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
          payment_method: {
            card: cardElement,
            billing_details: {
              name: name,
              phone: phone,
            },
          },
        });

        if (error) {
          throw new Error(error.message);
        }

        if (paymentIntent.status === 'succeeded') {
          console.log('Payment succeeded!', paymentIntent.id);
          
          // Clear cart
          localStorage.removeItem('alsDeliOrder');
          
          // Store confirmation data
          localStorage.setItem('orderConfirmation', JSON.stringify({
            confirmationNumber: confirmationNumber,
            name: name,
            phone: phone,
            pickupTime: pickupTime,
            items: orderData.items,
            total: total,
            paymentIntentId: paymentIntent.id
          }));

          // Redirect to confirmation page
          window.location.href = 'order-confirmed.html';
        } else {
          throw new Error('Payment was not successful. Please try again.');
        }

      } catch (error) {
        console.error('Payment error:', error);
        alert(`Payment failed: ${error.message}`);
        
        // Re-enable button
        payBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnSpinner.classList.add('hidden');
      }
    }

    // Phone number formatting
    document.getElementById('customer-phone').addEventListener('input', (e) => {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 3 && value.length <= 6) {
        value = value.slice(0, 3) + '-' + value.slice(3);
      } else if (value.length > 6) {
        value = value.slice(0, 3) + '-' + value.slice(3, 6) + '-' + value.slice(6, 10);
      }
      e.target.value = value;
    });
  </script>

</body>
</html>
